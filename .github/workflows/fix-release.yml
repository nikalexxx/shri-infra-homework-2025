name: Fix Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: '–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1.2.3)'
        required: true

env:
  REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
  IMAGE_NAME: app
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      fix_number: ${{ steps.fix.outputs.fix_number }}
    steps:
      - uses: actions/checkout@v4

      - name: –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ñ–∏–∫—Å–∞
        id: fix
        run: |
          VERSION="${{ github.event.inputs.release_version }}"
          LAST_TAG=$(git tag --list "v${VERSION}_fix*" --sort=-v:refname | head -n1)

          if [[ -z "$LAST_TAG" ]]; then
            FIX_NUMBER=1
          else
            LAST_NUM=$(echo "$LAST_TAG" | grep -oP 'fix\K[0-9]+')
            FIX_NUMBER=$((LAST_NUM + 1))
          fi

          echo "fix_number=$FIX_NUMBER" >> $GITHUB_OUTPUT

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          npm ci
          npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: |
          npm ci
          npm test

  release:
    needs: [setup, lint, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      VERSION: ${{ github.event.inputs.release_version }}
      FIX: ${{ needs.setup.outputs.fix_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Yandex Cloud CR Login
        uses: yc-actions/yc-cr-login@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

      - name: Build Docker Image with Tags
        run: |
          IMAGE="$REGISTRY/$IMAGE_NAME"
          docker build -t "$IMAGE:${VERSION}_fix${FIX}" -t "$IMAGE:${VERSION}_latest" .
          docker push "$IMAGE:${VERSION}_fix${FIX}"
          docker push "$IMAGE:${VERSION}_latest"

      - name: Create Git Tag
        run: |
          TAG="v${VERSION}_fix${FIX}"
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Get Previous Tag
        id: prev_tag
        run: |
          PREV=$(git tag --list "v${VERSION}_fix*" --sort=-v:refname | grep -v "v${VERSION}_fix${FIX}" | head -n1)
          if [ -z "$PREV" ]; then
            PREV="v${VERSION}"
          fi
          echo "prev_tag=$PREV" >> "$GITHUB_OUTPUT"

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ issue
        run: |
          set -euo pipefail
          
          echo "üîç –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ issue —Å –º–µ—Ç–∫–æ–π release_${VERSION}"
          ISSUE_NUMBER=$(gh issue list --json number --label "release_${VERSION}" | jq -r '.[0].number')
          
          if [[ -z "$ISSUE_NUMBER" || "$ISSUE_NUMBER" == "null" ]]; then
            echo "‚ùå Issue —Å –º–µ—Ç–∫–æ–π release_${VERSION} –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          TAG="${VERSION}_fix${FIX}"
          IMAGE_FIX="${REGISTRY}/${IMAGE_NAME}:${TAG}"
          IMAGE_LATEST="${REGISTRY}/${IMAGE_NAME}:${VERSION}_latest"
          
          echo "üìú –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–æ–º–º–∏—Ç–æ–≤ –æ—Ç ${PREV_TAG} –¥–æ HEAD"
          CHANGELOG=$(git log "${PREV_TAG}..HEAD" --pretty=format:"* %s (%h)")
          
          echo "üìù –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"
          COMMENT=$(cat <<EOF
          üîß **–§–∏–∫—Å —Ä–µ–ª–∏–∑–∞ \`${VERSION}\`**
          üìÖ –î–∞—Ç–∞ —Ñ–∏–∫—Å–∞: ${DATE}
          üë§ –ê–≤—Ç–æ—Ä: @${GITHUB_ACTOR}
          üßæ –í–µ—Ä—Å–∏—è: \`${TAG}\`
          üì¶ Docker –æ–±—Ä–∞–∑—ã:
            \`${IMAGE_FIX}\`
            \`${IMAGE_LATEST}\`
          üîç –ö–æ–º–º–∏—Ç—ã —Å –º–æ–º–µ–Ω—Ç–∞ \`${PREV_TAG}\`:
            \`\`\`markdown
            ${CHANGELOG}
            \`\`\`
            EOF
            )
            
            echo "üí¨ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ issue #${ISSUE_NUMBER}"
            gh issue comment "$ISSUE_NUMBER" --body "$COMMENT"
        env:
          VERSION: ${{ env.VERSION }}
          FIX: ${{ env.FIX }}
          DATE: ${{ steps.date.outputs.date }}
          PREV_TAG: ${{ steps.prev_tag.outputs.prev_tag }}
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          GITHUB_ACTOR: ${{ github.actor }}