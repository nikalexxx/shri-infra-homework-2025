name: Deploy prod

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        required: true
        description: "Version to release"
        default: 16
      issue-number:
        type: number
        required: true
        description: "Release Issue number id"
        default: 6

jobs:
  start_docker:
    runs-on: ubuntu-latest
    steps:
      - name: Auth SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/secret_key
          chmod 600 ~/.ssh/secret_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Yandex Cloud CR "Login" Action for GitHub Actions
        uses: yc-actions/yc-cr-login@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_JSON_CREDENTIALS }}

      - name: Deploy
        run: |
          ssh -i ~/.ssh/secret_key ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
          "sudo docker rm -f ${{ secrets.YC_REGISTRY_ID }} || true && \
           sudo docker run --name ${{ secrets.YC_REGISTRY_ID }} -d -p 3000:3000 \
           cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ inputs.version }}_latest"

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–ª–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        id: comment_body
        run: |
          BODY=$(cat <<EOF
          üöÄ **–ü—Ä–æ–¥ —Ä–µ–ª–∏–∑ \`${{ inputs.version }}\` –≤—ã–∫–∞—á–∞–Ω**
          üìÖ –î–∞—Ç–∞: ${{ steps.date.outputs.date }}
          üë§ –ê–≤—Ç–æ—Ä: @${{ github.actor }}
          üê≥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä: \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ inputs.version }}_latest\`
          üß† –°–µ—Ä–≤–µ—Ä: \`${{ secrets.SSH_HOST }}\`
          EOF
          )
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment to GitHub Issue
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ inputs.issue-number }}
          body: ${{ steps.comment_body.outputs.body }}
