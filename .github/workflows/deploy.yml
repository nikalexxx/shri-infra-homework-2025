name: Deploy to Prod

description: "Ğ’Ñ‹ĞºĞ°Ñ‡ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ´-ÑĞµÑ€Ğ²ĞµÑ€ Ñ‡ĞµÑ€ĞµĞ· SSH"

on:
    workflow_dispatch:
        inputs:
            version:
                required: true
                description: "Ğ’ĞµÑ€ÑĞ¸Ñ Docker-Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹ĞºĞ°Ñ‚ĞºĞ¸ Ğ² Ğ¿Ñ€Ğ¾Ğ´"

jobs:
    deploy:
        name: ğŸš€ Deploy version to production server
        runs-on: ubuntu-latest
        env:
            REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
            IMAGE_NAME: app
            VERSION: ${{ github.event.inputs.version }}

        steps:
            - name: ğŸ“ƒ Ğ›Ğ¾Ğ³ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ¸ Ñ€ĞµĞµÑÑ‚Ñ€Ğ°
              run: |
                  echo "Ğ‘ÑƒĞ´ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ÑŒ Ğ²ĞµÑ€ÑĞ¸Ñ: $VERSION"
                  echo "Ğ˜Ğ· Ñ€ĞµĞµÑÑ‚Ñ€Ğ°: $REGISTRY/$IMAGE_NAME"

            - name: ğŸ§° Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Yandex CLI
              run: |
                  curl https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
                  echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

            - name: Authenticate YC CLI
              run: |
                  yc config set token "${{ secrets.YC_OAUTH_TOKEN }}"
                  yc config set cloud-id "${{ secrets.YC_CLOUD_ID }}"
                  yc config set folder-id "${{ secrets.YC_FOLDER_ID }}"

            - name: ğŸ”— ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Docker Ñ‡ĞµÑ€ĞµĞ· yc CLI
              run: yc container registry configure-docker

            - name: âœ¨ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ° Ğ² YCR
              run: |
                  echo "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ‚ĞµĞ³Ğ° ${VERSION}_latest Ğ² YCR..."
                  docker pull $REGISTRY/$IMAGE_NAME:${VERSION}_latest >/dev/null || {
                    echo "âŒ ĞĞ±Ñ€Ğ°Ğ· Ñ Ñ‚ĞµĞ³Ğ¾Ğ¼ ${VERSION}_latest Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Container Registry"
                    exit 1
                  }
                  echo "âœ… ĞĞ±Ñ€Ğ°Ğ· Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞºĞ°Ñ‡Ğ°Ğ½."

            - name: ğŸšš ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
              uses: appleboy/ssh-action@v0.1.7
              with:
                  host: ${{ secrets.VM_IP }}
                  username: ${{ secrets.VM_SSH_USER }}
                  key: ${{ secrets.VM_SSH_KEY }}
                  envs: IMAGE_NAME,REGISTRY,VERSION
                  script: |
                      echo "=== ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ ==="

                      echo "1. ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ YC access token..."
                      echo '${{ secrets.YC_SERVICE_KEY }}' > key.json
                      ACCESS_TOKEN=$(cat key.json | jq -r .access_token)

                      echo "2. Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² Docker Registry..."
                      echo "$ACCESS_TOKEN" | docker login --username oauth --password-stdin cr.yandex

                      echo "3. ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°..."
                      docker stop app || true
                      docker rm app || true

                      echo "4. ĞŸÑƒĞ»Ğ» Ğ¾Ğ±Ñ€Ğ°Ğ·Ğ°..."
                      docker pull $REGISTRY/$IMAGE_NAME:${VERSION}_latest

                      echo "5. Ğ—Ğ°Ğ¿ÑƒÑĞº ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°..."
                      docker run -d --name app -p 80:3000 $REGISTRY/$IMAGE_NAME:${VERSION}_latest

                      echo "6. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°..."
                      docker ps | grep app
                      echo "âœ… Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½."

            - name: ĞĞ°Ğ¹Ñ‚Ğ¸ Ğ½Ğ¾Ğ¼ĞµÑ€ issue Ğ¿Ğ¾ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºÑƒ (Ğ²ĞµÑ€ÑĞ¸Ğ¸)
              id: find_issue
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½ Ğ»Ğ¸ gh
                  if ! command -v gh &> /dev/null
                  then
                  echo "gh cli Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½, ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼..."
                  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                  sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
                  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                  sudo apt update
                  sudo apt install gh -y
                  fi

                  ISSUE_NUMBER=$(gh issue list --repo ${{ github.repository }} --state open --json number,title --limit 100 \
                  | jq -r '.[] | select(.title=="'${{ github.event.inputs.version }}'") | .number')

                  if [ -z "$ISSUE_NUMBER" ]; then
                  echo "ĞÑˆĞ¸Ğ±ĞºĞ°: Issue Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼ '${{ github.event.inputs.version }}' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾"
                  exit 1
                  fi

                  echo "ĞĞ°Ğ¹Ğ´ĞµĞ½ issue Ğ½Ğ¾Ğ¼ĞµÑ€: $ISSUE_NUMBER"
                  echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTP

            - name: ğŸ“Š Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ Ğ² GitHub Issue
              uses: peter-evans/create-or-update-comment@v4
              with:
                  issue-number: ${{ github.event.inputs.version }}
                  body: |
                      ğŸŒ Ğ ĞµĞ»Ğ¸Ğ· **${{ github.event.inputs.version }}** Ğ²Ñ‹ĞºĞ°Ñ‡Ğ°Ğ½ Ğ² Ğ¿Ñ€Ğ¾Ğ´  
                      ğŸ“… Ğ”Ğ°Ñ‚Ğ°: $(date +%F)  
                      ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€: @${{ github.actor }}  
                      ğŸ“¦ ĞĞ±Ñ€Ğ°Ğ·: `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}_latest`
