name: Deploy
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð·Ð°
      - name: Check image exists
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}
          REGISTRY: ${{ secrets.REGISTRY_ID }}
        run: |
          echo "$YC_SA_KEY" | docker login \
            --username json_key \
            --password-stdin \
            cr.yandex
          docker pull $REGISTRY/app:${{ inputs.release_version }}_latest

      # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VM_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker stop app || true
            docker rm app || true
            docker run -d --name app -p 3000:3000 \
              $REGISTRY/app:${{ inputs.release_version }}_latest

      # ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð² Issue
      - name: Add deploy comment
        uses: actions/github-script@v6
        with:
          script: |
            // ÐŸÐ¾Ð¸ÑÐº Issue Ñ€ÐµÐ»Ð¸Ð·Ð°
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });
            
            const releaseIssue = issues.find(issue => 
              issue.title.includes(`Release ${{ inputs.release_version }}`)
            );
            
            if (releaseIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: releaseIssue.number,
                body: `ðŸš€ Deployed to production!\n\n` +
                      `**Date:** ${new Date().toISOString()}\n` +
                      `**By:** ${context.actor}`
              });
            }