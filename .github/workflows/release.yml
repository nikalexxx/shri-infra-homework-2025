name: Manual Release

on:
  workflow_dispatch:

env:
  REGISTRY: cr.yandex/<идентификатор_реестра>
  IMAGE_NAME: app
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Linter
        run: |
          npm ci
          npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Tests
        run: |
          npm ci
          npm test

  release:
    needs: [lint, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    env:
      VERSION: ${{ github.run_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get current date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d')" >> "$GITHUB_OUTPUT"

      - name: Create release branch
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git checkout -b releases/${{ env.VERSION }}
          git push origin releases/${{ env.VERSION }}

      - name: Log in to Yandex Container Registry
        run: |
          echo "${{ secrets.YC_CR_TOKEN }}" | docker login -u json_key --password-stdin cr.yandex

      - name: Build Docker image
        run: |
          docker build -t $REGISTRY/$IMAGE_NAME:${{ env.VERSION }} .
          docker tag $REGISTRY/$IMAGE_NAME:${{ env.VERSION }} $REGISTRY/$IMAGE_NAME:${{ env.VERSION }}_latest

      - name: Push Docker image
        run: |
          docker push $REGISTRY/$IMAGE_NAME:${{ env.VERSION }}
          docker push $REGISTRY/$IMAGE_NAME:${{ env.VERSION }}_latest

      - name: Get last release tag
        id: last_tag
        run: echo "tag=$(git describe --tags --abbrev=0 || echo '')" >> "$GITHUB_OUTPUT"

      - name: Generate changelog
        id: changelog
        run: |
          if [ -z "${{ steps.last_tag.outputs.tag }}" ]; then
            log=$(git log --pretty=format:"* %s (%h)")
          else
            log=$(git log ${{ steps.last_tag.outputs.tag }}..HEAD --pretty=format:"* %s (%h)")
          fi
          echo "log<<EOF" >> $GITHUB_OUTPUT
          echo "$log" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create git tag for release
        run: |
          git tag ${{ env.VERSION }}
          git push origin ${{ env.VERSION }}

      - name: Update CHANGELOG.md
        run: |
          echo -e "## ${{ env.VERSION }} - ${{ steps.date.outputs.date }}\n\n${{ steps.changelog.outputs.log }}\n\n$(cat CHANGELOG.md)" > CHANGELOG.md
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "chore(release): update changelog for ${{ env.VERSION }}"
          git push

      - name: Create GitHub Issue
        run: |
          gh issue create \
            --title "Release ${{ env.VERSION }}" \
            --body "**Дата:** ${{ steps.date.outputs.date }}  
            **Автор:** ${{ github.actor }}
            **Версия:** ${{ env.VERSION }}
            **Образ:** $REGISTRY/$IMAGE_NAME:${{ env.VERSION }}
            **Коммиты:**
            ${{ steps.changelog.outputs.log }}" \
            --repo ${{ github.repository }}
