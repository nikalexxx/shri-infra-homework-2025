name: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Ç—Ñ–∏–∫—Å–∞–º–∏

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: '–í–µ—Ä—Å–∏—è —Ä–µ–ª–∏–∑–∞ –¥–ª—è —Ñ–∏–∫—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5)'
        required: true
        type: string

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/${{ github.event.inputs.release_version }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä
      run: npm run lint

  test:
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/${{ github.event.inputs.release_version }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
      run: npm test

  hotfix:
    needs: [lint, test]
    runs-on: ubuntu-latest

    steps:
    - name: –ü–æ–ª—É—á–∏—Ç—å –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      uses: actions/checkout@v4
      with:
        ref: releases/${{ github.event.inputs.release_version }}
        fetch-depth: 0

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: npm ci

    - name: –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
      run: npm run build

    - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Yandex Container Registry
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: json_key
        password: ${{ secrets.YC_SERVICE_ACCOUNT_KEY }}

    - name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å Docker –æ–±—Ä–∞–∑ —Ö–æ—Ç—Ñ–∏–∫—Å–∞
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_fix${{ github.run_number }}
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_latest
        platforms: linux/amd64

    - name: –°–æ–∑–¥–∞—Ç—å Git —Ç–µ–≥
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag ${{ github.event.inputs.release_version }}_fix${{ github.run_number }}
        git push origin ${{ github.event.inputs.release_version }}_fix${{ github.run_number }}

    - name: –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ —Ä–µ–ª–∏–∑–∞/—Ñ–∏–∫—Å–∞
      id: prev_tag
      run: |
        PREV_TAG=$(git tag --sort=-version:refname | grep -E '^${{ github.event.inputs.release_version }}(_fix[0-9]+)?$' | head -2 | tail -1)
        if [ -z "$PREV_TAG" ]; then
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

    - name: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–º–∏—Ç—ã —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞/—Ñ–∏–∫—Å–∞
      id: commits
      run: |
        COMMITS=$(git log --oneline ${{ steps.prev_tag.outputs.prev_tag }}..${{ github.sha }} --pretty=format:"- %s (%h)")
        echo "commits<<EOF" >> $GITHUB_OUTPUT
        echo "$COMMITS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: –û–±–Ω–æ–≤–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ issues
      uses: actions/github-script@v7
      with:
        script: |
          // –ù–∞–π—Ç–∏ issue —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ä–µ–ª–∏–∑–æ–º
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: 'release',
            state: 'open'
          });

          const releaseIssue = issues.find(issue =>
            issue.title.includes(`–†–µ–ª–∏–∑ ${{ github.event.inputs.release_version }}`)
          );

          if (releaseIssue) {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: releaseIssue.number,
              body: `## üîß –•–æ—Ç—Ñ–∏–∫—Å ${{ github.event.inputs.release_version }}_fix${{ github.run_number }}

              **–î–∞—Ç–∞ —Ñ–∏–∫—Å–∞:** ${new Date().toLocaleString('ru-RU')}
              **–ê–≤—Ç–æ—Ä —Ñ–∏–∫—Å–∞:** @${{ github.actor }}

              ### –ö–æ–º–º–∏—Ç—ã:
              ${{ steps.commits.outputs.commits }}

              ### Docker –æ–±—Ä–∞–∑:
              \`cr.yandex/${{ secrets.YC_REGISTRY_ID }}/app:${{ github.event.inputs.release_version }}_fix${{ github.run_number }}\`

              ### –°—Ç–∞—Ç—É—Å:
              ‚úÖ –•–æ—Ç—Ñ–∏–∫—Å —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –¥–µ–ø–ª–æ—é
              `
            });

            console.log('–û–±–Ω–æ–≤–ª–µ–Ω issue #' + releaseIssue.number);
          } else {
            console.log('–ù–µ –Ω–∞–π–¥–µ–Ω —Å–≤—è–∑–∞–Ω–Ω—ã–π issue –¥–ª—è –≤–µ—Ä—Å–∏–∏ ${{ github.event.inputs.release_version }}');
          }
