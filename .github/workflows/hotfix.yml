name: Hotfix
on:
  workflow_dispatch:
    inputs:
      release:
        description: "–ù–æ–º–µ—Ä —Ä–µ–ª–∏–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1)"
        required: true

env:
  REG: cr.yandex/${{ secrets.YC_REGISTRY_ID }}

jobs:
  fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # –ø–µ—Ä–µ—Ö–æ–¥ –≤ –≤–µ—Ç–∫—É —Ä–µ–ª–∏–∑–∞
      - name: Checkout release branch
        run: |
          git fetch origin "releases/${{ inputs.release }}"
          git checkout "releases/${{ inputs.release }}"

      # –ø—Ä–æ–≤–µ—Ä–∫–∏
      - uses: actions/setup-node@v4
        with: {node-version: 20, cache: 'npm'}
      - run: npm ci
      - run: npm test -- --watchAll=false

      # –≤–µ—Ä—Å–∏—è —Ñ–∏–∫—Å–∞ = –Ω–æ–º–µ—Ä –∑–∞–ø—É—Å–∫–∞
      - id: ver
        run: echo "FIX=${{ github.run_number }}" >> $GITHUB_OUTPUT

      # —Å–±–æ—Ä–∫–∞ –∏ push –¥–≤—É—Ö —Ç–µ–≥–æ–≤
      - name: Build & push image
        run: |
          TAG1=$REG/app:${{ inputs.release }}_fix${{ steps.ver.outputs.FIX }}
          TAG2=$REG/app:${{ inputs.release }}_latest
          docker build -t $TAG1 -t $TAG2 .
          docker login -u iam -p "${{ secrets.YC_IAM_TOKEN }}" cr.yandex
          docker push --all-tags $REG/app

      # git-tag v<rel>_fix<run>
      - name: Git tag
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "github-actions[bot]"
          git tag v${{ inputs.release }}_fix${{ steps.ver.outputs.FIX }}
          git push origin v${{ inputs.release }}_fix${{ steps.ver.outputs.FIX }}

      # –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Issue Release X
      - name: Comment in release issue
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          ISSUE=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --search "Release ${{ inputs.release }}" --json number -q '.[0].number')
          if [ -n "$ISSUE" ]; then
            gh issue comment "$ISSUE" --repo "$GITHUB_REPOSITORY" \
            --body "**üõ† Fix ${{ steps.ver.outputs.FIX }}** ‚Äî $(date)\n–ê–≤—Ç–æ—Ä: @${{ github.actor }}\n–¢–µ–≥: \`v${{ inputs.release }}_fix${{ steps.ver.outputs.FIX }}\`"
          fi
